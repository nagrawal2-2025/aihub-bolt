name: Deploy Backend API to Azure Container Apps

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

env:
  CONTAINER_APP_NAME: tesa-aihub-api
  CONTAINER_APP_PORT: 3001
  ACR_NAME: tesaihubdevacr
  ACR_IMAGE_NAME: tesa-aihub-api
  ACR_TAG: latest
  AZURE_RESOURCE_GROUP: rg-tesa-aihub-dev
  AZURE_CONTAINERAPPS_ENVIRONMENT: tesa-aihub-env

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Schritt 2.1: Repo auschecken
      - name: Checkout repository
        uses: actions/checkout@v4

      # Schritt 2.2: Azure Login (wir brauchen Service Principal Secrets dafür)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Schritt 2.3: In Azure Container Registry einloggen
      - name: Azure Container Registry Login
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      # Schritt 2.4: Docker Image für das Backend bauen
      - name: Build backend image
        run: |
          docker build \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:${{ env.ACR_TAG }} \
            ./backend

      # Schritt 2.5: Docker Image in Azure Container Registry pushen
      - name: Push backend image
        run: |
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:${{ env.ACR_TAG }}

      # Schritt 2.6: Container App erstellen oder updaten
      - name: Deploy to Azure Container Apps
        run: |
          az containerapp up \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.AZURE_CONTAINERAPPS_ENVIRONMENT }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.ACR_IMAGE_NAME }}:${{ env.ACR_TAG }} \
            --target-port ${{ env.CONTAINER_APP_PORT }} \
            --ingress external \
            --env-vars \
              PORT=${{ env.CONTAINER_APP_PORT }} \
              DB_HOST=${{ secrets.DB_HOST }} \
              DB_PORT=${{ secrets.DB_PORT }} \
              DB_NAME=${{ secrets.DB_NAME }} \
              DB_USER=${{ secrets.DB_USER }} \
              DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              DB_SSL=${{ secrets.DB_SSL }} \
              JWT_SECRET=${{ secrets.JWT_SECRET }}
